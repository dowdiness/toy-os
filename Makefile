# =================================================================
# OS自作 "Hello, World!" (ブートセクタ版) Makefile
# =================================================================

# 変数定義
AS      = as
LD      = ld
OBJCOPY = objcopy
DD      = dd
QEMU    = qemu-system-i386

SRC     = boot.s
OBJ     = boot.o
IMG     = boot.img
FINAL_IMG = boot_512.img

TTEXT   = 0x7c00
ARCH    = elf_i386

# -----------------------------------------------------------------
# デフォルトターゲット: 全てをビルドし、QEMUで実行する
# -----------------------------------------------------------------
all: $(FINAL_IMG) run

# -----------------------------------------------------------------
# 最終イメージの生成: boot.img から 512バイトにトリミング
# -----------------------------------------------------------------
$(FINAL_IMG): $(IMG)
	# ddでファイルの先頭512バイトを切り出す
	$(DD) if=$(IMG) of=$(FINAL_IMG) bs=512 count=1

# -----------------------------------------------------------------
# バイナリイメージの生成 (objcopyとldの組み合わせ)
# -----------------------------------------------------------------
$(IMG): $(OBJ)
	# リンク: 32bit ELFを生成 (objcopyに渡すため)
	$(LD) -m $(ARCH) -Ttext $(TTEXT) $(OBJ) -o boot.elf
	# objcopy: ELFから純粋なバイナリコードを抽出
	$(OBJCOPY) -O binary boot.elf $(IMG)

# -----------------------------------------------------------------
# アセンブル
# -----------------------------------------------------------------
$(OBJ): $(SRC)
	# 32ビット i386アーキテクチャでアセンブル
	$(AS) --32 $(SRC) -o $(OBJ)

# -----------------------------------------------------------------
# 実行
# -----------------------------------------------------------------
run: $(FINAL_IMG)
	# QEMUでフロッピーとして起動
	$(QEMU) -fda $(FINAL_IMG) -boot a

# -----------------------------------------------------------------
# クリーンアップ
# -----------------------------------------------------------------
clean:
	rm -f $(OBJ) boot.elf $(IMG) $(FINAL_IMG)

# .PHONY: all, run, clean などのターゲットは常に実行
.PHONY: all run clean
