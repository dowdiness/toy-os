# boot.s (セミコロン完全排除版)

.code16                # CPUを16ビットリアルモードに設定する
# .global start          # リンカ/ローダのために 'start' シンボルを公開

.org 0x0               # ファイルの先頭（ブートセクタの開始アドレス）からコードを配置

start:
    cli                # 割り込みを無効化
    cld                # 文字列操作の方向フラグを前方（増加）に設定

    # === レジスタの初期化 ===
    # セグメントレジスタを確実に0に設定する
    xorw %ax, %ax      # AX レジスタを 0 にクリア
    movw %ax, %ds      # DS (データセグメント) を 0 に設定
    movw %ax, %es      # ES (エクストラセグメント) を 0 に設定

    # === スタックの設定 ===
    # SP (スタックポインタ) を 0x7c00 に設定し、SS (スタックセグメント) を 0 に設定
    mov $0x7c00, %sp   # SP を設定
    movw %ax, %ss      # SS を 0 に設定

    # メッセージのアドレスを SI (ソースインデックス) に設定
    mov $message, %si

# === 文字列表示ループ ===
print:
    lodsb              # DS:SI が指すバイト (メッセージ文字) を AL にロードし、SIをインクリメント
    cmp $0, %al        # ロードした文字 (AL) がヌル文字 (終端) かチェック
    je stop            # ヌル文字であれば 'stop' へジャンプ

    # === BIOSコール (文字表示) ===
    mov $0x0e, %ah     # AH=0x0e は、BIOSの「Teletype出力サービス」
    mov $0x0, %bx      # BH=0 (表示ページ番号)
    int $0x10          # BIOSサービスコールを実行し、AL の文字を画面に出力する

    jmp print          # 次の文字を処理するためにループの先頭に戻る

# === 停止 ===
stop:
    hlt                # CPUを停止させる

message:
    .byte 0x0D, 0x0A      # 画面を次の行の先頭に移動 (改行コード)
    .asciz "Hello, World!"

# === ブートセクタの定義 ===
# コードとメッセージの後にパディングを挿入し、ファイルの510バイト目まで移動
. = start + 510
.word 0xaa55           # MBRのシグネチャ
